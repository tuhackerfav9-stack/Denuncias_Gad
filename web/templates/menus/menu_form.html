{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">
        {% if object %}Editar men√∫{% else %}Crear men√∫{% endif %}
      </h3>
      <p class="text-muted mb-0">
        Define nombre, URL, icono, orden y el men√∫ padre (si aplica). Luego asigna qu√© grupos lo ver√°n.
      </p>
    </div>
  </div>

  {# ‚úÖ errores generales del form (non_field_errors) #}
  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      <strong>Revisa esto:</strong>
      <div>{{ form.non_field_errors }}</div>
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="card">
      <div class="card-body">

        <h5 class="mb-3">Datos del men√∫</h5>

        <div class="row">
          <div class="col-md-6">
            {{ form.nombre|as_crispy_field }}
          </div>
          <div class="col-md-6">
            {{ form.url|as_crispy_field }}
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            {{ form.icono|as_crispy_field }}
            <small class="text-muted">
              Ej: <code>icon-grid</code>, <code>icon-layout</code>, <code>mdi mdi-home</code>
            </small>
          </div>
          <div class="col-md-3">
            {{ form.orden|as_crispy_field }}
          </div>
          <div class="col-md-3">
            {{ form.padre|as_crispy_field }}
            <small class="text-muted">
              Si es un submen√∫, elige aqu√≠ su padre. Si es men√∫ principal, d√©jalo vac√≠o.
            </small>
          </div>
        </div>

        <hr class="my-4">

        <h5 class="mb-2">Visibilidad por grupos</h5>
        <p class="text-muted mb-3">
          Selecciona los grupos que podr√°n ver este men√∫. <br>
          <strong>Si no eliges ning√∫n grupo, se mostrar√° a todos</strong> (incluye funcionarios).
        </p>

        {# ‚úÖ Permisos como checklist (mejor UX) #}
        {% if form.permisos.errors %}
          <div class="alert alert-danger py-2">
            <strong>Error en grupos:</strong> {{ form.permisos.errors }}
          </div>
        {% endif %}

        <div class="row">
          <div class="col-12">
            <div class="border rounded p-3">
              {% for checkbox in form.permisos %}
                <div class="form-check mb-2">
                  {{ checkbox.tag }}
                  <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                    {{ checkbox.choice_label }}
                  </label>
                </div>
              {% empty %}
                <div class="text-muted">
                  No hay grupos creados todav√≠a. Crea primero los grupos (FUNCIONARIO, TICS_ADMIN).
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="ti-save"></i> Guardar
          </button>
          <a href="{% url 'web:menu_list' %}" class="btn btn-light">
            Cancelar
          </a>
        </div>

      </div>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // üé® Colores estilo "Salcedo" (azul + naranja)
  const SALCEDO_BLUE = "#0B3A6E";
  const SALCEDO_ORANGE = "#F28C28";

  // ‚úÖ si el backend usa messages, los mostramos con iziToast
  {% if messages %}
    {% for message in messages %}
      (function() {
        let type = "{{ message.tags|default:'info' }}";
        let title = "Notificaci√≥n";
        let color = SALCEDO_BLUE;

        if (type.includes("success")) { title = "√âxito"; color = SALCEDO_BLUE; }
        else if (type.includes("error") || type.includes("danger")) { title = "Error"; color = "#D32F2F"; }
        else if (type.includes("warning")) { title = "Atenci√≥n"; color = SALCEDO_ORANGE; }
        else { title = "Info"; color = SALCEDO_BLUE; }

        iziToast.show({
          title: title,
          message: "{{ message|escapejs }}",
          position: "topRight",
          timeout: 3500,
          backgroundColor: color,
          messageColor: "#fff",
          titleColor: "#fff",
          progressBarColor: SALCEDO_ORANGE
        });
      })();
    {% endfor %}
  {% endif %}
</script>
{% endblock %}
