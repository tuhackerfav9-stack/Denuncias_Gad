{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">{% if object %}Editar men√∫{% else %}Crear men√∫{% endif %}</h3>
      <p class="text-muted mb-0">
        Define nombre, URL, icono, orden y el men√∫ padre (si aplica). Luego asigna qu√© grupos lo ver√°n.
      </p>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      <strong>Revisa esto:</strong>
      <div>{{ form.non_field_errors }}</div>
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
    {{ form.media }}

    <style>
      /* ‚úÖ Select2 siempre a 100% dentro del grid */
      .select2-container { width: 100% !important; z-index: 9999; }

      .select2-container--default .select2-selection--single,
      .select2-container--default .select2-selection--multiple {
        width: 100% !important;
        min-height: calc(1.5em + .75rem + 2px);
        padding: .375rem .75rem;
        border: 1px solid #ced4da;
        border-radius: .375rem;
        display: flex;
        align-items: center;
      }

      .select2-container--default .select2-selection--single .select2-selection__rendered {
        padding-left: 0 !important;
        line-height: 1.5 !important;
      }

      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 100% !important;
        top: 0 !important;
      }

      /* ‚úÖ Ocultar el input real de icono pero mantenerlo para guardar */
      .icon-hidden {
        position: absolute !important;
        left: -9999px !important;
        width: 1px !important;
        height: 1px !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      /* ‚úÖ Grid iconos */
      .icon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 10px;
        max-height: 260px;
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px;
        background: #fff;
      }

      .icon-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        background: #f8f9fa;
      }

      .icon-card:hover { background: #eef5ff; }

      .icon-card code { font-size: 12px; }
    </style>

    <div class="card">
      <div class="card-body">

        <h5 class="mb-3">Datos del men√∫</h5>

        <div class="row">
          <div class="col-md-6">
            {{ form.nombre|as_crispy_field }}
          </div>
          <div class="col-md-6">
            {{ form.url|as_crispy_field }}
          </div>
        </div>

        <div class="row">
          <!-- ‚úÖ ICONOS: un solo bloque (buscador + preview + grid) -->
          <div class="col-md-6">

            {# Campo real (oculto) para que Django guarde en BD #}
            <div class="icon-hidden">
              {{ form.icono|as_crispy_field }}
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label mb-1">Icono</label>

              <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Preview:</span>
                <span id="iconPreview" class="fs-4"></span>
              </div>
            </div>

            <input id="iconSearch" type="text" class="form-control"
                   placeholder="Buscar icono (espa√±ol): usuario, casa, alerta, configuraci√≥n...">

            <div class="mt-2 small text-muted">
              Tip: escribe y elige un icono. Se guardar√° autom√°ticamente.
              <span class="ms-1">Ej: <code>bi bi-flag</code>, <code>mdi mdi-home</code>, <code>ti-layout</code></span>
            </div>

            <div id="iconGrid" class="icon-grid mt-3"></div>
          </div>

          <div class="col-md-3">
            {{ form.orden|as_crispy_field }}
          </div>

          <div class="col-md-3">
            {{ form.padre|as_crispy_field }}
            <small class="text-muted">
              Si es un submen√∫, elige aqu√≠ su padre. Si es men√∫ principal, d√©jalo vac√≠o.
            </small>
          </div>
        </div>

        <hr class="my-4">

        <h5 class="mb-2">Visibilidad por grupos</h5>
        <p class="text-muted mb-3">
          Selecciona los grupos que podr√°n ver este men√∫.
          <br><strong>Si no eliges ning√∫n grupo, se mostrar√° a todos</strong>.
        </p>

        {{ form.permisos|as_crispy_field }}

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="ti-save"></i> Guardar
          </button>
          <a href="{% url 'web:menu_list' %}" class="btn btn-light">
            Cancelar
          </a>
        </div>

      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // üé® Colores estilo "Salcedo" (azul + naranja)
  const SALCEDO_BLUE = "#0B3A6E";
  const SALCEDO_ORANGE = "#F28C28";

  // ‚úÖ iziToast con messages (sin perder tu l√≥gica)
  {% if messages %}
    {% for message in messages %}
      (function() {
        let type = "{{ message.tags|default:'info' }}";
        let title = "Notificaci√≥n";
        let color = SALCEDO_BLUE;

        if (type.includes("success")) { title = "√âxito"; color = SALCEDO_BLUE; }
        else if (type.includes("error") || type.includes("danger")) { title = "Error"; color = "#D32F2F"; }
        else if (type.includes("warning")) { title = "Atenci√≥n"; color = SALCEDO_ORANGE; }
        else { title = "Info"; color = SALCEDO_BLUE; }

        iziToast.show({
          title: title,
          message: "{{ message|escapejs }}",
          position: "topRight",
          timeout: 3500,
          backgroundColor: color,
          messageColor: "#fff",
          titleColor: "#fff",
          progressBarColor: SALCEDO_ORANGE
        });
      })();
    {% endfor %}
  {% endif %}
</script>

<script>
(function(){
  const inputIcono = document.getElementById("id_icono");     // ‚úÖ existe pero est√° oculto
  const preview = document.getElementById("iconPreview");
  const search = document.getElementById("iconSearch");
  const grid = document.getElementById("iconGrid");

  const ICONS = [
    {label:"Casa / Inicio", cls:"bi bi-house"},
    {label:"Tablero / Dashboard", cls:"bi bi-speedometer2"},
    {label:"Men√∫ / Lista", cls:"bi bi-list"},
    {label:"Denuncia / Reporte", cls:"bi bi-megaphone"},
    {label:"Documento", cls:"bi bi-file-earmark-text"},
    {label:"Carpeta", cls:"bi bi-folder"},
    {label:"Usuario", cls:"bi bi-person"},
    {label:"Usuario verificado", cls:"bi bi-person-check"},
    {label:"Usuarios / Grupo", cls:"bi bi-people"},
    {label:"Funcionario / Credencial", cls:"bi bi-person-badge"},
    {label:"Configuraci√≥n", cls:"bi bi-gear"},
    {label:"Herramientas", cls:"bi bi-tools"},
    {label:"Seguridad / Escudo", cls:"bi bi-shield-lock"},
    {label:"Candado", cls:"bi bi-lock"},
    {label:"Llave", cls:"bi bi-key"},
    {label:"Notificaci√≥n", cls:"bi bi-bell"},
    {label:"Alerta", cls:"bi bi-exclamation-triangle"},
    {label:"Error", cls:"bi bi-x-circle"},
    {label:"Correcto", cls:"bi bi-check-circle"},
    {label:"Informaci√≥n", cls:"bi bi-info-circle"},
    {label:"Ayuda", cls:"bi bi-question-circle"},
    {label:"Buscar", cls:"bi bi-search"},
    {label:"Filtro", cls:"bi bi-funnel"},
    {label:"Mapa", cls:"bi bi-map"},
    {label:"Ubicaci√≥n", cls:"bi bi-geo-alt"},
    {label:"Tel√©fono", cls:"bi bi-telephone"},
    {label:"Correo", cls:"bi bi-envelope"},
    {label:"Chat", cls:"bi bi-chat-dots"},
    {label:"Enviar", cls:"bi bi-send"},
    {label:"Calendario", cls:"bi bi-calendar-event"},
    {label:"Historial", cls:"bi bi-clock-history"},
    {label:"Estad√≠stica", cls:"bi bi-bar-chart"},
    {label:"Gr√°fico", cls:"bi bi-graph-up"},
    {label:"Descargar", cls:"bi bi-download"},
    {label:"Subir", cls:"bi bi-upload"},
    {label:"Imprimir", cls:"bi bi-printer"},
    {label:"Editar", cls:"bi bi-pencil-square"},
    {label:"Eliminar", cls:"bi bi-trash"},
    {label:"Agregar", cls:"bi bi-plus-circle"},
    {label:"Refrescar", cls:"bi bi-arrow-repeat"},
    {label:"Salir", cls:"bi bi-box-arrow-right"},
    {label:"Enlace", cls:"bi bi-link-45deg"},
    {label:"Adjuntar", cls:"bi bi-paperclip"},
    {label:"Imagen", cls:"bi bi-image"},
    {label:"C√°mara", cls:"bi bi-camera"},
    {label:"Micr√≥fono", cls:"bi bi-mic"},
    {label:"Silencio", cls:"bi bi-volume-mute"},
    {label:"Favorito", cls:"bi bi-star"},
    {label:"Bandera", cls:"bi bi-flag"},
    {label:"Etiqueta", cls:"bi bi-tag"},
    {label:"Dinero", cls:"bi bi-cash"},
    {label:"Banco", cls:"bi bi-bank"},
    {label:"Edificio", cls:"bi bi-building"},
    {label:"Carretera", cls:"bi bi-signpost-2"},
    {label:"Agua", cls:"bi bi-droplet"},
    {label:"Incendio", cls:"bi bi-fire"},
    {label:"Checklist", cls:"bi bi-card-checklist"},
    {label:"Tabla", cls:"bi bi-table"},
    {label:"Cuadr√≠cula", cls:"bi bi-grid"},
    {label:"Capas", cls:"bi bi-layers"},
    {label:"Servidor", cls:"bi bi-hdd-network"},
    {label:"Base de datos", cls:"bi bi-database"},
    {label:"Nube", cls:"bi bi-cloud"},
    {label:"WiFi", cls:"bi bi-wifi"},
    {label:"C√≥digo", cls:"bi bi-code-slash"},
    {label:"Terminal", cls:"bi bi-terminal"},
    {label:"Bug", cls:"bi bi-bug"},
    {label:"Guardar", cls:"bi bi-save"}
  ];

  function setPreview(cls){
    if(!preview) return;
    preview.className = cls || "";
    preview.innerHTML = cls ? "" : "<span class='text-muted'>‚Äî</span>";
  }

  function pick(cls){
    if(!inputIcono) return;
    inputIcono.value = cls;
    inputIcono.dispatchEvent(new Event("input"));
    setPreview(cls);
  }

  function render(list){
    grid.innerHTML = "";
    list.forEach(item => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "icon-card w-100 text-start";
      btn.innerHTML = `
        <i class="${item.cls}" style="font-size:20px;"></i>
        <div style="line-height:1.15">
          <div style="font-weight:600">${item.label}</div>
          <div class="text-muted"><code>${item.cls}</code></div>
        </div>
      `;
      btn.addEventListener("click", () => pick(item.cls));
      grid.appendChild(btn);
    });
  }

  // init
  render(ICONS);
  setPreview((inputIcono?.value || "").trim());

  search.addEventListener("input", function(){
    const q = this.value.trim().toLowerCase();
    if(!q) return render(ICONS);
    render(ICONS.filter(i =>
      i.label.toLowerCase().includes(q) || i.cls.toLowerCase().includes(q)
    ));
  });

})();
</script>
{% endblock %}
