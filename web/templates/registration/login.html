{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ingreso al Sistema | GAD Salcedo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="{% static 'assets/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- iziToast -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --gad-primary:#0d6efd;
      --gad-primary-dark:#0b5ed7;
      --gad-border:#E5E7EB;
      --gad-muted:#9CA3AF;
      --gad-danger:#D32F2F;
      --gad-warn:#F28C28;
      --gad-info:#0B3A6E;
    }

    body{
      font-family:'Poppins',sans-serif;
      min-height:100vh;
      background:
        linear-gradient(rgba(116,116,116,.92), rgba(116,116,116,.92)),
        url("{% static 'assets/img/fondo_web.png' %}") center/cover no-repeat;
    }

    .login-card{
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,.96);
      border-radius: 18px;
      box-shadow: 0 25px 60px rgba(0,0,0,.25);
      padding: 34px;
    }

    .login-title{
      color: var(--gad-primary);
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 20px;
    }

    .form-label{
      font-weight: 600;
      margin-bottom: 8px;
    }
    .req{
      color: var(--gad-danger);
      font-weight: 700;
      margin-left: 2px;
    }

    .input-wrap{ position:relative; }

    /* iconos DERECHA */
    .input-icon-right{
      position:absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gad-muted);
      display:flex;
      align-items:center;
      justify-content:center;
      width: 22px;
      height: 22px;
      pointer-events:none;
    }

    /* botón ojo DERECHA */
    .input-icon-right-btn{
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid #D1D5DB;
      background: #fff;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .input-icon-right-btn:hover{
      background:#F9FAFB;
    }

    .form-control{
      border-radius: 14px;
      padding: 12px 52px 12px 14px; /* espacio para icono derecha */
      height: 50px;
      border: 1px solid var(--gad-border);
      font-size: 15px;
    }

    /* para password: deja espacio para botón */
    #id_password.form-control{
      padding-right: 62px;
    }

    .form-control:focus{
      border-color:#93C5FD;
      box-shadow: 0 0 0 .25rem rgba(13,110,253,.18);
    }

    /* estado error (jquery validate) */
    .form-control.is-invalid{
      border-color: var(--gad-danger) !important;
      box-shadow: 0 0 0 .25rem rgba(211,47,47,.12) !important;
    }

    .btn-gad{
      background: var(--gad-primary);
      border:none;
      border-radius: 14px;
      padding: 12px;
      font-weight: 700;
      color:#fff;
      height: 52px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .btn-gad:hover{ background: var(--gad-primary-dark); }

    /* iziToast pro */
    .iziToast{
      border-radius: 12px !important;
      box-shadow: 0 14px 30px rgba(0,0,0,.16) !important;
      padding: 14px 16px !important;
      overflow: hidden !important;
    }
    .iziToast > .iziToast-body .iziToast-texts{ margin-left: 44px !important; }
    .iziToast > .iziToast-body .iziToast-title{ font-weight:700 !important; font-size:14px !important; }
    .iziToast > .iziToast-body .iziToast-message{ font-size:14px !important; }
    .iziToast > .iziToast-progressbar{ height:3px !important; }

    @media (max-width: 420px){
      .login-card{ padding: 26px; }
    }
  </style>
</head>

<body class="d-flex align-items-center justify-content-center">

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-7 col-lg-6 col-xl-5">

        <div class="login-card">

          <div class="text-center mb-4">
            <h5 class="login-title d-flex align-items-center justify-content-center gap-2 mb-0">
              <!-- puntitos -->
              <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <circle cx="6" cy="6" r="2"></circle>
                <circle cx="6" cy="18" r="2"></circle>
                <circle cx="18" cy="12" r="2"></circle>
                <circle cx="12" cy="12" r="2" opacity=".65"></circle>
                <circle cx="12" cy="6" r="2" opacity=".35"></circle>
              </svg>
              Ingreso al Sistema
            </h5>
          </div>

          <form id="loginForm" method="post" novalidate>
            {% csrf_token %}

            <!-- Usuario -->
            <div class="mb-3">
              <label class="form-label">Usuario<span class="req">*</span></label>
              <div class="input-wrap">
                <input
                  type="text"
                  name="username"
                  id="id_username"
                  class="form-control"
                  placeholder="Ingrese su usuario"
                  autocomplete="username"
                  required
                >
                <span class="input-icon-right">
                  <!-- icono correo -->
                  <svg aria-hidden="true" fill="none" focusable="false" height="1em" role="presentation" viewBox="0 0 24 24" width="1em">
                    <path d="M17 3.5H7C4 3.5 2 5 2 8.5V15.5C2 19 4 20.5 7 20.5H17C20 20.5 22 19 22 15.5V8.5C22 5 20 3.5 17 3.5ZM17.47 9.59L14.34 12.09C13.68 12.62 12.84 12.88 12 12.88C11.16 12.88 10.31 12.62 9.66 12.09L6.53 9.59C6.21 9.33 6.16 8.85 6.41 8.53C6.67 8.21 7.14 8.15 7.46 8.41L10.59 10.91C11.35 11.52 12.64 11.52 13.4 10.91L16.53 8.41C16.85 8.15 17.33 8.2 17.58 8.53C17.84 8.85 17.79 9.33 17.47 9.59Z" fill="currentColor"></path>
                  </svg>
                </span>
              </div>
            </div>

            <!-- Contraseña -->
            <div class="mb-4">
              <label class="form-label">Contraseña<span class="req">*</span></label>
              <div class="input-wrap">
                <input
                  type="password"
                  name="password"
                  id="id_password"
                  class="form-control"
                  placeholder="Ingrese su contraseña"
                  autocomplete="current-password"
                  required
                >

                <!-- botón ojo -->
                <button class="input-icon-right-btn" type="button" id="togglePassword" aria-label="Mostrar/ocultar contraseña">
                  <!-- ojo -->
                  <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <path d="M12 5c5 0 9 4 10 7-1 3-5 7-10 7S3 15 2 12c1-3 5-7 10-7Z" stroke="currentColor" stroke-width="1.7"/>
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.7"/>
                  </svg>
                </button>

                <!-- candado a la derecha (detrás del botón no se ve, por eso lo dejo más a la izquierda) -->
                <span class="input-icon-right" style="right: 58px;">
                  <svg aria-hidden="true" fill="none" focusable="false" height="1em" role="presentation" viewBox="0 0 24 24" width="1em">
                    <path d="M12.0011 17.3498C12.9013 17.3498 13.6311 16.6201 13.6311 15.7198C13.6311 14.8196 12.9013 14.0898 12.0011 14.0898C11.1009 14.0898 10.3711 14.8196 10.3711 15.7198C10.3711 16.6201 11.1009 17.3498 12.0011 17.3498Z" fill="currentColor"></path>
                    <path d="M18.28 9.53V8.28C18.28 5.58 17.63 2 12 2C6.37 2 5.72 5.58 5.72 8.28V9.53C2.92 9.88 2 11.3 2 14.79V16.65C2 20.75 3.25 22 7.35 22H16.65C20.75 22 22 20.75 22 16.65V14.79C22 11.3 21.08 9.88 18.28 9.53ZM12 18.74C10.33 18.74 8.98 17.38 8.98 15.72C8.98 14.05 10.34 12.7 12 12.7C13.66 12.7 15.02 14.06 15.02 15.72C15.02 17.39 13.67 18.74 12 18.74ZM7.35 9.44C7.27 9.44 7.2 9.44 7.12 9.44V8.28C7.12 5.35 7.95 3.4 12 3.4C16.05 3.4 16.88 5.35 16.88 8.28V9.45C16.8 9.45 16.73 9.45 16.65 9.45H7.35V9.44Z" fill="currentColor"></path>
                  </svg>
                </span>
              </div>
            </div>

            <div class="d-grid">
              <button class="btn btn-gad" type="submit">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M10 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 12h11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M20 4v16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Ingresar
              </button>
            </div>
          </form>

        </div>

        <p class="text-center text-white small mt-4 mb-0">
          © {% now "Y" %} GAD Municipal de Salcedo
        </p>

      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- jQuery Validation -->
  <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>

  <!-- iziToast -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // ===== Toggle password =====
    (function(){
      const btn = document.getElementById("togglePassword");
      const input = document.getElementById("id_password");
      const icon = document.getElementById("eyeIcon");
      if(!btn || !input) return;

      btn.addEventListener("click", function(){
        const show = input.type === "password";
        input.type = show ? "text" : "password";
        if(icon) icon.style.opacity = show ? "1" : ".55";
      });
    })();

    // ===== Toast helper =====
    function gadToast(title, message, color){
      iziToast.show({
        title: title,
        message: message,
        position: "topRight",
        timeout: 2200,
        closeOnClick: true,
        backgroundColor: "#ffffff",
        titleColor: "#111827",
        messageColor: "#374151",
        progressBarColor: color,
        iconColor: color
      });
    }

    // ===== jQuery Validation (ES) =====
    (function(){
      const $form = $("#loginForm");
      if(!$form.length) return;

      $form.validate({
        ignore: [],
        errorClass: "is-invalid",
        validClass: "is-valid",
        // NO mostramos texto bajo el input
        errorPlacement: function(){},
        highlight: function(element){
          $(element).addClass("is-invalid").removeClass("is-valid");
        },
        unhighlight: function(element){
          $(element).removeClass("is-invalid").addClass("is-valid");
        },
        rules:{
          username:{ required:true, minlength: 3 },
          password:{ required:true, minlength: 3 }
        },
        messages:{
          username:{
            required:"Ingrese su usuario",
            minlength:"Mínimo 3 caracteres"
          },
          password:{
            required:"Ingrese su contraseña",
            minlength:"Mínimo 3 caracteres"
          }
        },
        invalidHandler: function(event, validator){
          // toma el primer error y lo muestra en toast
          const first = validator.errorList?.[0];
          const msg = first?.message || "Revise los campos obligatorios.";
          gadToast("Error", msg, "#D32F2F");
        }
      });

      // al submit, forzamos validar para que no salga el HTML5 default
      $form.on("submit", function(e){
        if(!$form.valid()){
          e.preventDefault();
        }
      });
    })();

    // ===== Mensajes Django (messages) + error de login =====
    document.addEventListener("DOMContentLoaded", function(){
      {% for message in messages %}
        {% if "error" in message.tags or "danger" in message.tags %}
          gadToast("Error", "{{ message|escapejs }}", "#D32F2F");
        {% elif "success" in message.tags %}
          gadToast("Éxito", "{{ message|escapejs }}", "#0B3A6E");
        {% elif "warning" in message.tags %}
          gadToast("Atención", "{{ message|escapejs }}", "#F28C28");
        {% else %}
          gadToast("Info", "{{ message|escapejs }}", "#0B3A6E");
        {% endif %}
      {% endfor %}

      {% if form.errors %}
        gadToast("Acceso denegado", "Usuario o contraseña incorrectos", "#D32F2F");
      {% endif %}
    });
  </script>

</body>
</html>
