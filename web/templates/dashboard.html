{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .card-link-wrapper {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .card-link-wrapper:hover {
    text-decoration: none;
    color: inherit;
  }

  .dashboard-kpi-card,
  .dashboard-mini-kpi-card {
    border: 0;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
  }

  .dashboard-kpi-card .card-body {
    min-height: 138px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 1.35rem 1.35rem;
  }

  .dashboard-mini-kpi-card .card-body {
    min-height: 61px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: .9rem 1.1rem;
  }

  .dashboard-kpi-card .kpi-title,
  .dashboard-mini-kpi-card .kpi-title {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: .35rem;
    color: rgba(255, 255, 255, 0.95);
  }

  .dashboard-kpi-card .kpi-value {
    font-size: 2.15rem;
    line-height: 1;
    font-weight: 700;
    color: #fff;
    margin-bottom: .35rem;
  }

  .dashboard-mini-kpi-card .kpi-value {
    font-size: 1.35rem;
    line-height: 1;
    font-weight: 700;
    color: #fff;
    margin-bottom: .2rem;
  }

  .dashboard-kpi-card .kpi-subtitle,
  .dashboard-mini-kpi-card .kpi-subtitle {
    font-size: .9rem;
    color: rgba(255, 255, 255, 0.82);
    margin: 0;
  }

  .kpi-total {
    background: linear-gradient(135deg, #6d8ff0 0%, #7f9cf5 100%);
  }

  .kpi-pendiente {
    background: linear-gradient(135deg, #4b49ac 0%, #5f5dc8 100%);
  }

  .kpi-resuelta {
    background: linear-gradient(135deg, #28a745 0%, #41c56b 100%);
  }

  .kpi-proceso {
    background: linear-gradient(135deg, #6d6be9 0%, #7a77ee 100%);
  }

  .kpi-rechazada {
    background: linear-gradient(135deg, #f06f75 0%, #ef7d84 100%);
  }

  .dashboard-section-card {
    border: 0;
    border-radius: 22px;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.06);
  }

  .dashboard-section-card .card-body {
    padding: 1.35rem 1.35rem 1.2rem 1.35rem;
  }

  .dashboard-section-title {
    font-size: 1.7rem;
    font-weight: 700;
    margin-bottom: .2rem;
  }

  .dashboard-section-subtitle {
    color: #6c757d;
    margin-bottom: 0;
  }

  .soft-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .chart-canvas-box {
    position: relative;
    width: 100%;
    min-height: 380px;
  }

  .chart-canvas-box.chart-canvas-box-lg {
    min-height: 460px;
  }

  .map-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .map-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .map-legend-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: .85rem;
    color: #4b5563;
    background: #f8f9fa;
    border-radius: 999px;
    padding: .35rem .7rem;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
  }

  .legend-pendiente { background: #fbbc04; }
  .legend-proceso   { background: #4285f4; }
  .legend-resuelta  { background: #34a853; }
  .legend-rechazada { background: #ea4335; }

  #map {
    width: 100%;
    height: 560px;
    border-radius: 18px;
    overflow: hidden;
    border: 1px solid #eef0f4;
  }

  .list-row-title {
    font-weight: 600;
    color: #2b2b2b;
    margin-right: 10px;
  }

  .progress {
    border-radius: 999px;
    height: 10px;
    background: #edf1f7;
  }

  .progress .progress-bar {
    border-radius: 999px;
  }

  .dashboard-empty {
    padding: 1rem;
    border-radius: 14px;
    background: #f8f9fc;
    border: 1px dashed #d8dbe7;
    color: #6c757d;
  }

  @media (max-width: 767.98px) {
    .dashboard-kpi-card .card-body {
      min-height: 120px;
    }

    .dashboard-kpi-card .kpi-value {
      font-size: 1.8rem;
    }

    #map {
      height: 430px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 grid-margin">
    <div>
      <h3 class="dashboard-section-title">Dashboard</h3>
      <p class="dashboard-section-subtitle">Resumen del sistema de denuncias</p>
    </div>
  </div>
</div>

<!-- KPIs -->
<div class="row">
  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <a href="{% url 'web:denuncia_list' %}" class="card-link-wrapper w-100">
      <div class="card dashboard-kpi-card kpi-total h-100">
        <div class="card-body">
          <div>
            <p class="kpi-title">Total de Denuncias</p>
            <p class="kpi-value">{{ total_denuncias }}</p>
          </div>
          <p class="kpi-subtitle">Este mes: {{ denuncias_este_mes }}</p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <div class="card dashboard-kpi-card kpi-resuelta h-100">
      <div class="card-body">
        <div>
          <p class="kpi-title">Pendientes</p>
          <p class="kpi-value">{{ denuncias_pendientes }}</p>
        </div>
        <p class="kpi-subtitle">Por revisar</p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <div class="card dashboard-kpi-card kpi-proceso h-100">
      <div class="card-body">
        <div>
          <p class="kpi-title">En Proceso</p>
          <p class="kpi-value">{{ denuncias_en_proceso }}</p>
        </div>
        <p class="kpi-subtitle">Atendiéndose</p>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-xl-3 grid-margin">
    <div class="d-flex flex-column h-100" style="gap: 1rem;">
      <div class="card dashboard-mini-kpi-card kpi-pendiente">
        <div class="card-body">
          <p class="kpi-title mb-1">Resueltas</p>
          <p class="kpi-value mb-1">{{ denuncias_pendientes }}</p>
          <p class="kpi-subtitle">Cerradas</p>
        </div>
      </div>

      <div class="card dashboard-mini-kpi-card kpi-rechazada">
        <div class="card-body">
          <p class="kpi-title mb-1">Rechazadas</p>
          <p class="kpi-value mb-1">{{ denuncias_rechazadas }}</p>
          <p class="kpi-subtitle">Cerradas</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Fila 1 -->
<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card w-100">
      <div class="card-body">
        <p class="soft-title">Denuncias por Estado</p>
        {{ chart_estado_denuncias }}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card w-100">
      <div class="card-body">
        <p class="soft-title">Denuncias por Departamento</p>

        {% if dept_chart_values %}
          <div class="chart-canvas-box chart-canvas-box-lg">
            <canvas id="departamentosChart"></canvas>
          </div>
        {% else %}
          <div class="dashboard-empty">No hay datos de departamentos para mostrar.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Fila 2 -->
<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card w-100">
      <div class="card-body">
        <p class="soft-title">Denuncias por Semana</p>
        {{ chart_denuncias_semana }}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card w-100">
      <div class="card-body">
        <p class="soft-title">Denuncias por Mes</p>
        {{ chart_denuncias_mes }}
      </div>
    </div>
  </div>
</div>

<!-- Fila 3 -->
<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card w-100">
      <div class="card-body">
        <p class="soft-title">Ciudadanos con más denuncias (Top 10)</p>
        {{ chart_ciudadanos_top }}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card w-100">
      <div class="card-body">
        <p class="soft-title">Denuncias por Tipo</p>
        {{ chart_kpi7 }}
      </div>
    </div>
  </div>
</div>

<!-- Listas -->
<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card">
      <div class="card-body">
        <p class="soft-title">Denuncias por Tipo (Listado)</p>

        {% if denuncias_por_tipo %}
          {% for item in denuncias_por_tipo %}
            <div class="d-flex justify-content-between align-items-center">
              <span class="list-row-title">{{ item.tipo_denuncia__nombre }}</span>
              <span class="badge badge-primary">{{ item.count }}</span>
            </div>
            <div class="progress mt-2 mb-3">
              <div class="progress-bar bg-primary"
                   role="progressbar"
                   style="width: {% widthratio item.count total_denuncias 100 %}%">
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="alert alert-info mb-0">No hay denuncias registradas.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card dashboard-section-card">
      <div class="card-body">
        <p class="soft-title">Departamentos con más Denuncias</p>

        {% if departamentos_con_denuncias %}
          {% for item in departamentos_con_denuncias %}
            <div class="d-flex justify-content-between align-items-center">
              <span class="list-row-title">{{ item.asignado_departamento__nombre }}</span>
              <span class="badge badge-success">{{ item.count }}</span>
            </div>
            <div class="progress mt-2 mb-3">
              <div class="progress-bar bg-success"
                   role="progressbar"
                   style="width: {% widthratio item.count total_denuncias 100 %}%">
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="alert alert-info mb-0">No hay departamentos con denuncias asignadas.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- MAPA -->
<div class="row">
  <div class="col-12 grid-margin stretch-card">
    <div class="card dashboard-section-card">
      <div class="card-body">
        <div class="map-toolbar">
          <div>
            <p class="soft-title mb-1">Mapa de Denuncias</p>
            <p class="text-muted mb-0">
              {{ map_scope_text }} ({{ map_points|length }} registradas)
            </p>
          </div>

          <div class="map-legend">
            <span class="map-legend-item"><span class="legend-dot legend-pendiente"></span> Pendiente</span>
            <span class="map-legend-item"><span class="legend-dot legend-proceso"></span> En proceso</span>
            <span class="map-legend-item"><span class="legend-dot legend-resuelta"></span> Resuelta</span>
            <span class="map-legend-item"><span class="legend-dot legend-rechazada"></span> Rechazada</span>
          </div>
        </div>

        <div id="map"></div>
      </div>
    </div>
  </div>
</div>

{{ dept_chart_labels|json_script:"dept-chart-labels" }}
{{ dept_chart_full_labels|json_script:"dept-chart-full-labels" }}
{{ dept_chart_values|json_script:"dept-chart-values" }}
{{ dept_chart_colors|json_script:"dept-chart-colors" }}
{{ map_points|json_script:"map-points-data" }}
{% endblock %}

{% block extra_js %}
<script src="{% static 'skydash/assets/vendors/chart.js/chart.umd.js' %}"></script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const deptCanvas = document.getElementById("departamentosChart");

    if (deptCanvas) {
      const labels = JSON.parse(document.getElementById("dept-chart-labels").textContent);
      const fullLabels = JSON.parse(document.getElementById("dept-chart-full-labels").textContent);
      const values = JSON.parse(document.getElementById("dept-chart-values").textContent);
      const colors = JSON.parse(document.getElementById("dept-chart-colors").textContent);

      const dynamicHeight = Math.max(360, labels.length * 62);
      deptCanvas.parentElement.style.height = dynamicHeight + "px";

      new Chart(deptCanvas, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Cantidad",
            data: values,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 1.5,
            borderRadius: 8,
            barThickness: 18
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: "y",
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function (tooltipItems) {
                  const index = tooltipItems[0].dataIndex;
                  return fullLabels[index];
                }
              }
            }
          },
          layout: {
            padding: {
              top: 10,
              right: 10,
              bottom: 5,
              left: 10
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Cantidad"
              },
              grid: {
                color: "rgba(0,0,0,0.05)"
              },
              ticks: {
                precision: 0
              }
            },
            y: {
              title: {
                display: true,
                text: "Departamento"
              },
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }
  });

  window.initMap = function () {
    const mapEl = document.getElementById("map");
    if (!mapEl) return;

    const points = JSON.parse(document.getElementById("map-points-data").textContent || "[]");

    const SALCEDO_CENTER = { lat: -1.045, lng: -78.590 };
    const DEFAULT_ZOOM = 13;

    const map = new google.maps.Map(mapEl, {
      center: SALCEDO_CENTER,
      zoom: DEFAULT_ZOOM,
      mapTypeId: "roadmap",
      fullscreenControl: true,
      streetViewControl: false,
      mapTypeControl: true,
      gestureHandling: "greedy",
      styles: [
        {
          featureType: "poi",
          elementType: "labels",
          stylers: [{ visibility: "off" }]
        }
      ]
    });

    const infoWindow = new google.maps.InfoWindow();
    const bounds = new google.maps.LatLngBounds();
    const markers = [];

    const stateColors = {
      pendiente: "#fbbc04",
      en_proceso: "#4285f4",
      resuelta: "#34a853",
      rechazado: "#ea4335"
    };

    function isValidCoord(lat, lng) {
      return Number.isFinite(lat) &&
             Number.isFinite(lng) &&
             lat >= -90 && lat <= 90 &&
             lng >= -180 && lng <= 180 &&
             !(lat === 0 && lng === 0);
    }

    function badgeClass(estado) {
      if (estado === "resuelta") return "success";
      if (estado === "en_proceso") return "primary";
      if (estado === "rechazado") return "danger";
      return "warning";
    }

    const repeatedCoordsCounter = {};
    const validPoints = points.filter(p => isValidCoord(Number(p.lat), Number(p.lng)));

    if (!validPoints.length) {
      if (window.iziToast) {
        iziToast.info({
          title: "Mapa",
          message: "No hay denuncias con ubicación válida para mostrar.",
          position: "topRight",
          timeout: 3500
        });
      }
      return;
    }

    validPoints.forEach((p) => {
      let lat = Number(p.lat);
      let lng = Number(p.lng);

      const key = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      repeatedCoordsCounter[key] = (repeatedCoordsCounter[key] || 0) + 1;
      const repeatIndex = repeatedCoordsCounter[key] - 1;

      if (repeatIndex > 0) {
        const offset = repeatIndex * 0.00005;
        lat = lat + offset;
        lng = lng + offset;
      }

      const position = { lat, lng };

      const marker = new google.maps.Marker({
        position,
        title: p.tipo,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 9,
          fillColor: stateColors[p.estado] || "#7e57c2",
          fillOpacity: 1,
          strokeColor: "#ffffff",
          strokeWeight: 2
        }
      });

      marker.addListener("click", () => {
        infoWindow.setContent(`
          <div style="max-width: 320px;">
            <h6 style="margin: 0 0 8px 0; font-weight: 700;">${p.tipo || "Denuncia"}</h6>
            <p style="margin: 0 0 6px 0;"><b>Descripción:</b> ${p.descripcion || "Sin descripción"}</p>
            <p style="margin: 0 0 6px 0;">
              <b>Estado:</b>
              <span class="badge bg-${badgeClass(p.estado)}">${(p.estado || "").replace("_", " ")}</span>
            </p>
            <p style="margin: 0 0 6px 0;"><b>Ciudadano:</b> ${p.ciudadano || "Sin ciudadano"}</p>
            <p style="margin: 0 0 6px 0;"><b>Departamento:</b> ${p.departamento || "Sin asignar"}</p>
            <p style="margin: 0 0 10px 0;"><b>Fecha:</b> ${p.fecha || "-"}</p>
            <a href="${p.detalle_url}" class="btn btn-sm btn-primary" target="_blank">Ver detalles</a>
          </div>
        `);
        infoWindow.open(map, marker);
      });

      markers.push(marker);
      bounds.extend(position);
    });

    if (markers.length > 1 && window.markerClusterer) {
      new markerClusterer.MarkerClusterer({
        map,
        markers
      });
    } else {
      markers.forEach(marker => marker.setMap(map));
    }

    if (markers.length === 1) {
      map.setCenter(markers[0].getPosition());
      map.setZoom(16);
      markers[0].setMap(map);
    } else {
      map.fitBounds(bounds);

      google.maps.event.addListenerOnce(map, "idle", () => {
        if (map.getZoom() > 16) {
          map.setZoom(16);
        }
      });
    }
  };
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFFwwfbAcTQH432AY6w8CwRgwf2VBvWUI&callback=initMap" async defer></script>
{% endblock %}