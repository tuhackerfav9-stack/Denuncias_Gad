{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-1">{% if object %}Editar menú{% else %}Crear menú{% endif %}</h3>
      <p class="text-muted mb-0">
        Define nombre, URL, icono, orden y el menú padre (si aplica). Luego asigna qué grupos lo verán.
      </p>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      <strong>Revisa esto:</strong>
      <div>{{ form.non_field_errors }}</div>
    </div>
  {% endif %}

  <form method="post" novalidate>
    {% csrf_token %}
    {{ form.media }}

    <style>
      /* ✅ Select2 siempre a 100% y sin desbordes raros */
      .select2-container { width: 100% !important; }
      .select2-container--default .select2-selection--single,
      .select2-container--default .select2-selection--multiple {
        min-height: calc(1.5em + .75rem + 2px);
        border: 1px solid #ced4da;
        border-radius: .375rem;
        display: flex;
        align-items: center;
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 1.5 !important;
      }
      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 100% !important;
        top: 0 !important;
      }

      /* ✅ evita que el dropdown se “corte” */
      .card, .card-body { overflow: visible !important; }
    </style>

    <div class="card">
      <div class="card-body">

        <h5 class="mb-3">Datos del menú</h5>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            {{ form.nombre|as_crispy_field }}
          </div>

          <div class="col-12 col-md-6">
            {{ form.url|as_crispy_field }}
          </div>

          <div class="col-12 col-lg-6">
            <div class="d-flex justify-content-between align-items-center">
              <div class="flex-grow-1">
                {{ form.icono|as_crispy_field }}
                <small class="text-muted">
                  Ej: <code>bi bi-house</code>. (Se guarda automáticamente la clase seleccionada)
                </small>
              </div>
              <div class="ms-3 text-nowrap">
                <div class="text-muted small">Preview</div>
                <div id="iconPreview" class="fs-4"></div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            {{ form.orden|as_crispy_field }}
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            {{ form.padre|as_crispy_field }}
            <small class="text-muted">
              Si es submenú, elige su padre. Si es principal, déjalo vacío.
            </small>
          </div>
        </div>

        <hr class="my-4">

        <h5 class="mb-2">Visibilidad por grupos</h5>
        <p class="text-muted mb-3">
          Selecciona los grupos que podrán ver este menú.
          <br><strong>Si no eliges ningún grupo, se mostrará a todos</strong>.
        </p>

        {{ form.permisos|as_crispy_field }}

        <div class="d-flex gap-2 mt-4">
          <button type="submit" class="btn btn-primary">
            <i class="ti-save"></i> Guardar
          </button>
          <a href="{% url 'web:menu_list' %}" class="btn btn-light">
            Cancelar
          </a>
        </div>

      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // ✅ Select2 para iconos (igual estilo que Padre)
  const $icon = window.jQuery ? window.jQuery("#id_icono") : null;
  const preview = document.getElementById("iconPreview");

  function paintPreview(cls){
    if(!preview) return;
    preview.className = cls || "";
    preview.innerHTML = cls ? "" : "<span class='text-muted'>—</span>";
  }

  function formatIcon(state){
    // state.id == value del option (ej: "bi bi-house")
    if(!state.id) return state.text;
    const cls = state.id;
    return window.jQuery(
      `<span><i class="${cls}" style="font-size:18px; margin-right:8px;"></i>${state.text}</span>`
    );
  }

  if($icon && $icon.length){
    // Si ya tienes select2 global, esto lo deja bonito y con buscador
    $icon.select2({
      width: "100%",
      placeholder: "Buscar icono...",
      allowClear: true,
      templateResult: formatIcon,
      templateSelection: formatIcon,
      dropdownParent: $icon.closest(".card-body") // ✅ evita que se corte
    });

    // Preview inicial
    paintPreview($icon.val());

    // Preview al cambiar
    $icon.on("change", function(){
      paintPreview(this.value);
    });
  } else {
    // fallback si no hay jQuery (raro en select2, pero por si acaso)
    const iconSelect = document.getElementById("id_icono");
    if(iconSelect){
      paintPreview(iconSelect.value);
      iconSelect.addEventListener("change", ()=> paintPreview(iconSelect.value));
    }
  }
})();
</script>
{% endblock %}
