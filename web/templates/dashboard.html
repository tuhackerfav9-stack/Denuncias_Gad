{% extends 'base.html' %}
{% block content %}
<style>
  .card-link-wrapper {
    text-decoration: none;
    color: inherit;
    display: block;
}

.card-link-wrapper:hover {
    text-decoration: none;
    color: inherit;
}
.card-link-wrapper .card {
    transition: 0.2s;
    cursor: pointer;
}

.card-link-wrapper .card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}
</style>
<div class="row">
  <div class="col-12 grid-margin">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h3 class="font-weight-bold mb-1">Dashboard</h3>
        <p class="text-muted mb-0">Resumen del sistema de denuncias</p>
      </div>
    </div>
  </div>
</div>

<!-- KPIs (Skydash cards) -->
<div class="row">
  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <a href="{% url 'web:denuncia_list' %}" class="card-link-wrapper">
      <div class="card card-tale">
        <div class="card-body">
          <p class="mb-2">Total de Denuncias</p>
          <p class="fs-30 mb-1">{{ total_denuncias }}</p>
          <p class="mb-0 text-white-50">Este mes: {{ denuncias_este_mes }}</p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <div class="card card-dark-blue">
      <div class="card-body">
        <p class="mb-2">Pendientes</p>
        <p class="fs-30 mb-1">{{ denuncias_pendientes }}</p>
        <p class="mb-0 text-white-50">Por revisar</p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <div class="card card-light-blue">
      <div class="card-body">
        <p class="mb-2">En Proceso</p>
        <p class="fs-30 mb-1">{{ denuncias_en_proceso }}</p>
        <p class="mb-0 text-white-50">Atendiéndose</p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-3 grid-margin stretch-card">
    <div class="card card-light-danger">
      <div class="card-body">
        <p class="mb-2">Resueltas</p>
        <p class="fs-30 mb-1">{{ denuncias_resueltas }}</p>
        <p class="mb-0 text-white-50">Cerradas</p>
      </div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Denuncias por Estado</p>
        {{ chart_estado_denuncias }}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Denuncias por Departamento</p>
        {{ chart_denuncias_departamento }}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Denuncias por Semana</p>
        {{ chart_denuncias_semana }}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Denuncias por Mes</p>
        {{ chart_denuncias_mes }}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Ciudadanos con más denuncias (Top 10)</p>
        {{ chart_ciudadanos_top }}
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        {{ chart_kpi9 }}
      </div>
    </div>
  </div>
</div>

<!-- Listas (tipo y departamentos) -->
<div class="row">
  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Denuncias por Tipo</p>

        {% if denuncias_por_tipo %}
          {% for item in denuncias_por_tipo %}
            <div class="d-flex justify-content-between">
              <span class="font-weight-bold">{{ item.tipo_denuncia__nombre }}</span>
              <span class="badge badge-primary">{{ item.count }}</span>
            </div>
            <div class="progress progress-md mt-2 mb-3">
              <div class="progress-bar bg-primary" role="progressbar"
                   style="width: {% widthratio item.count total_denuncias 100 %}%">
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="alert alert-info mb-0">No hay denuncias registradas.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-3">Departamentos con más Denuncias</p>

        {% if departamentos_con_denuncias %}
          {% for item in departamentos_con_denuncias %}
            <div class="d-flex justify-content-between">
              <span class="font-weight-bold">{{ item.asignado_departamento__nombre }}</span>
              <span class="badge badge-success">{{ item.count }}</span>
            </div>
            <div class="progress progress-md mt-2 mb-3">
              <div class="progress-bar bg-success" role="progressbar"
                   style="width: {% widthratio item.count total_denuncias 100 %}%">
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="alert alert-info mb-0">No hay departamentos con denuncias asignadas.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- MAPA -->
<div class="row">
  <div class="col-12 grid-margin stretch-card">
    <div class="card">
      <div class="card-body">
        <p class="card-title mb-2">Mapa de Denuncias</p>
        <p class="text-muted mb-3">Mostrando las últimas {{ denuncias_mapa|length }} denuncias con ubicación</p>
        <div id="map" style="height: 500px; width: 100%; border-radius: 12px;"></div>
      </div>
    </div>
  </div>
</div>
<script>
window.initMap = function () {

  // Centro por defecto: Salcedo (ajústalo si quieres)
  const SALCEDO_CENTER = { lat: -1.0664793, lng: -78.5999933 };
  const DEFAULT_ZOOM = 13;

  const mapEl = document.getElementById("map");
  if (!mapEl) return;

  const map = new google.maps.Map(mapEl, {
    zoom: DEFAULT_ZOOM,
    center: SALCEDO_CENTER,
    mapTypeId: "roadmap",
    styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
  });

  const bounds = new google.maps.LatLngBounds();

  const estadoIconos = {
    pendiente: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
    en_proceso: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
    resuelto: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
    rechazado: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
  };

  // OJO: aquí NO ponemos defaults. Si no hay lat/lng, va vacío y se filtra.
  const denuncias = [
    {% for denuncia in denuncias_mapa %}
    {
      id: "{{ denuncia.id }}",
      // si viene null/blank, queda "" y parseFloat da NaN (y lo filtramos)
      lat: parseFloat("{{ denuncia.latitud|default_if_none:'' }}"),
      lng: parseFloat("{{ denuncia.longitud|default_if_none:'' }}"),
      descripcion: "{{ denuncia.descripcion|truncatechars:80|escapejs }}",
      tipo: "{{ denuncia.tipo_denuncia.nombre|escapejs }}",
      estado: "{{ denuncia.estado }}",
      ciudadano: "{{ denuncia.ciudadano.nombres|escapejs }} {{ denuncia.ciudadano.apellidos|escapejs }}",
      departamento: "{% if denuncia.asignado_departamento %}{{ denuncia.asignado_departamento.nombre|escapejs }}{% else %}Sin asignar{% endif %}",
      fecha: "{{ denuncia.created_at|date:'d/m/Y H:i' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  function isValidCoord(lat, lng) {
    // NaN o undefined
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return false;

    // 0,0 (típico de "no tengo ubicación")
    if (lat === 0 && lng === 0) return false;

    // rangos válidos
    if (lat < -90 || lat > 90) return false;
    if (lng < -180 || lng > 180) return false;

    return true;
  }

  const badge = (st) => {
    if (st === "resuelto") return "success";
    if (st === "en_proceso") return "info";
    if (st === "rechazado") return "danger";
    return "warning";
  };

  // Filtramos solo denuncias georreferenciadas reales
  const denunciasValidas = denuncias.filter(d => isValidCoord(d.lat, d.lng));

  // Si NO hay denuncias válidas → queda centrado en Salcedo, y aviso
  if (denunciasValidas.length === 0) {
    // opcional: aviso bonito
    if (window.iziToast) {
      iziToast.info({
        title: "Mapa",
        message: "No hay denuncias con ubicación (lat/lng) válida para mostrar.",
        position: "topRight",
        timeout: 3500
      });
    } else {
      console.warn("No hay denuncias con coordenadas válidas.");
    }
    return;
  }

  // Pintamos markers
  denunciasValidas.forEach(d => {
    const position = { lat: d.lat, lng: d.lng };

    const marker = new google.maps.Marker({
      position,
      map,
      title: d.tipo,
      icon: estadoIconos[d.estado] || "http://maps.google.com/mapfiles/ms/icons/purple-dot.png"
    });

    const infoWindow = new google.maps.InfoWindow({
      content: `
        <div style="max-width: 320px;">
          <h6 style="margin:0 0 8px 0;"><b>${d.tipo}</b></h6>
          <p style="margin:0 0 6px 0;"><b>Descripción:</b> ${d.descripcion}</p>
          <p style="margin:0 0 6px 0;"><b>Estado:</b> <span class="badge bg-${badge(d.estado)}">${(d.estado || "").replace("_"," ")}</span></p>
          <p style="margin:0 0 6px 0;"><b>Ciudadano:</b> ${d.ciudadano}</p>
          <p style="margin:0 0 6px 0;"><b>Departamento:</b> ${d.departamento}</p>
          <p style="margin:0 0 10px 0;"><b>Fecha:</b> ${d.fecha}</p>
          <a href="/web/denuncias/${d.id}/" class="btn btn-sm btn-primary" target="_blank">Ver detalles</a>
        </div>`
    });

    marker.addListener("click", () => infoWindow.open(map, marker));
    bounds.extend(position);
  });

  // Ajustar vista a bounds
  map.fitBounds(bounds);

  // limitar zoom máximo
  const listener = google.maps.event.addListener(map, "idle", () => {
    if (map.getZoom() > 16) map.setZoom(16);
    google.maps.event.removeListener(listener);
  });
};
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFFwwfbAcTQH432AY6w8CwRgwf2VBvWUI&callback=initMap" async defer></script>

{% endblock %}
